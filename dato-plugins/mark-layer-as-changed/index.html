<html>
    <head>
        <script type="module">
            import { connect } from 'https://cdn.jsdelivr.net/npm/datocms-plugin-sdk@0.8.2/+esm'

            const MODEL_NAME = 'Layer'

            function getModelName(payload, ctx) {
                const { type, id } = payload.data.relationships.item_type.data

                if (type !== 'item_type') {
                    return null
                }

                return ctx.itemTypes[id].attributes.name
            }

            connect({
                async onBeforeItemUpsert(payload, ctx) {
                    if (getModelName(payload, ctx) !== MODEL_NAME) {
                        return
                    }

                    const parameters = ctx.plugin.attributes.parameters

                    if (!parameters.changedLayers) {
                        parameters.changedLayers = []
                    }

                    if (!parameters.changedLayers.includes(payload.data.id)) {
                        await ctx.updatePluginParameters({
                            changedLayers: [ ...parameters.changedLayers, payload.data.id ],
                        })
                    }
                },
            }) 

        </script>
    </head>
</html>